<html>
  <head>
    <style>
* {
  margin: 0px;
  padding: 0px;
}

*, *:before, *:after {
  box-sizing: inherit;
}

html {
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  font-size: 18px;
  border-top: 6px #fddee9 solid;
  color: #444444;
  background-color: #FFFFFF;
}

li {
  margin-left: 30px;
}

a {
  color: #f92672;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

table {
  border-collapse: collapse;
  border-spacing: 0;
}

th {
  font-weight: bold;
}

th, td {
  padding: 12px 15px;
  border-bottom: 1px solid #E1E1E1;
}

</style>
<link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"/>
<link rel="icon" type="image/png" href="/icon.png">
</head>
<body>
<div style="width: 800px; margin: 0 auto;">
<a href='/'><img style="width: 100px; height: 100px; display: block; margin: 10px auto 10px auto;" src="data:image/svg+xml,%3C%3Fxml version%3D%221.0%22 encoding%3D%22UTF-8%22 standalone%3D%22no%22%3F%3E%0A%3Csvg width%3D%22100px%22 height%3D%22100px%22 viewBox%3D%220 0 100 100%22 version%3D%221.1%22 xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A    %3C%21-- Generator%3A Sketch 42 %2836781%29 - http%3A%2F%2Fwww.bohemiancoding.com%2Fsketch --%3E%0A    %3Ctitle%3Elogo%3C%2Ftitle%3E%0A    %3Cdesc%3ECreated with Sketch.%3C%2Fdesc%3E%0A    %3Cdefs%3E%0A        %3Crect id%3D%22path-1%22 x%3D%2215%22 y%3D%2215%22 width%3D%2235%22 height%3D%2236%22%3E%3C%2Frect%3E%0A        %3Cmask id%3D%22mask-2%22 maskContentUnits%3D%22userSpaceOnUse%22 maskUnits%3D%22objectBoundingBox%22 x%3D%220%22 y%3D%220%22 width%3D%2235%22 height%3D%2236%22 fill%3D%22white%22%3E%0A            %3Cuse xlink%3Ahref%3D%22%23path-1%22%3E%3C%2Fuse%3E%0A        %3C%2Fmask%3E%0A        %3Cellipse id%3D%22path-3%22 cx%3D%2215.1507839%22 cy%3D%2249.0755757%22 rx%3D%2215.0944915%22 ry%3D%2215.0944915%22%3E%3C%2Fellipse%3E%0A        %3Cmask id%3D%22mask-4%22 maskContentUnits%3D%22userSpaceOnUse%22 maskUnits%3D%22objectBoundingBox%22 x%3D%220%22 y%3D%220%22 width%3D%2230.188983%22 height%3D%2230.188983%22 fill%3D%22white%22%3E%0A            %3Cuse xlink%3Ahref%3D%22%23path-3%22%3E%3C%2Fuse%3E%0A        %3C%2Fmask%3E%0A        %3Cellipse id%3D%22path-5%22 cx%3D%2248.8492161%22 cy%3D%2215.3771436%22 rx%3D%2215.0944915%22 ry%3D%2215.0944915%22%3E%3C%2Fellipse%3E%0A        %3Cmask id%3D%22mask-6%22 maskContentUnits%3D%22userSpaceOnUse%22 maskUnits%3D%22objectBoundingBox%22 x%3D%220%22 y%3D%220%22 width%3D%2230.188983%22 height%3D%2230.188983%22 fill%3D%22white%22%3E%0A            %3Cuse xlink%3Ahref%3D%22%23path-5%22%3E%3C%2Fuse%3E%0A        %3C%2Fmask%3E%0A        %3Cellipse id%3D%22path-7%22 cx%3D%2248.8492161%22 cy%3D%2249.0900343%22 rx%3D%2215.0944915%22 ry%3D%2215.0944915%22%3E%3C%2Fellipse%3E%0A        %3Cmask id%3D%22mask-8%22 maskContentUnits%3D%22userSpaceOnUse%22 maskUnits%3D%22objectBoundingBox%22 x%3D%220%22 y%3D%220%22 width%3D%2230.188983%22 height%3D%2230.188983%22 fill%3D%22white%22%3E%0A            %3Cuse xlink%3Ahref%3D%22%23path-7%22%3E%3C%2Fuse%3E%0A        %3C%2Fmask%3E%0A        %3Cellipse id%3D%22path-9%22 cx%3D%2215.3980442%22 cy%3D%2215.3771436%22 rx%3D%2215.0944915%22 ry%3D%2215.0944915%22%3E%3C%2Fellipse%3E%0A        %3Cmask id%3D%22mask-10%22 maskContentUnits%3D%22userSpaceOnUse%22 maskUnits%3D%22objectBoundingBox%22 x%3D%220%22 y%3D%220%22 width%3D%2230.188983%22 height%3D%2230.188983%22 fill%3D%22white%22%3E%0A            %3Cuse xlink%3Ahref%3D%22%23path-9%22%3E%3C%2Fuse%3E%0A        %3C%2Fmask%3E%0A    %3C%2Fdefs%3E%0A    %3Cg id%3D%22Page-1%22 stroke%3D%22none%22 stroke-width%3D%221%22 fill%3D%22none%22 fill-rule%3D%22evenodd%22%3E%0A        %3Cg id%3D%22logo%22 stroke%3D%22%23000000%22 stroke-width%3D%222%22%3E%0A            %3Cg id%3D%22Group%22 transform%3D%22translate%2850.000000%2C 50.000000%29 rotate%28-315.000000%29 translate%28-50.000000%2C -50.000000%29 translate%2818.000000%2C 17.500000%29%22%3E%0A                %3Cuse id%3D%22Rectangle%22 mask%3D%22url%28%23mask-2%29%22 xlink%3Ahref%3D%22%23path-1%22%3E%3C%2Fuse%3E%0A                %3Cuse id%3D%22Oval-1%22 mask%3D%22url%28%23mask-4%29%22 fill%3D%22%23FFFFFF%22 xlink%3Ahref%3D%22%23path-3%22%3E%3C%2Fuse%3E%0A                %3Cuse id%3D%22Oval-1%22 mask%3D%22url%28%23mask-6%29%22 fill%3D%22%23FFFFFF%22 xlink%3Ahref%3D%22%23path-5%22%3E%3C%2Fuse%3E%0A                %3Cuse id%3D%22Oval-1%22 mask%3D%22url%28%23mask-8%29%22 fill%3D%22%23FFFFFF%22 xlink%3Ahref%3D%22%23path-7%22%3E%3C%2Fuse%3E%0A                %3Cuse id%3D%22Oval-1%22 mask%3D%22url%28%23mask-10%29%22 fill%3D%22%23FFFFFF%22 xlink%3Ahref%3D%22%23path-9%22%3E%3C%2Fuse%3E%0A            %3C%2Fg%3E%0A        %3C%2Fg%3E%0A    %3C%2Fg%3E%0A%3C%2Fsvg%3E"></a><div style='font-size:60px;font-weight:bold;text-align:center;'><a href='/pixsrv/'>Image-to-Image Demo</a></div><div style='color:#5c677f;font-size:20px;margin:8px;text-align:center;'>Interactive Image Translation with pix2pix-tensorflow</div><div style='color:#b2bace;font-size:16px;margin:10px 0 30px 0;text-align:center;'><span style='font-style:italic;text-align:center;'>Written by </span><span style='font-style:italic;text-align:center;'><a href='https://twitter.com/christophrhesse'>Christopher Hesse</a></span> -- <span style='font-family:Georgia, serif;font-style:italic;'><span>February 19<sup style='font-size:10px;margin-left:1px;margin-right:-6px;'>th</sup>, 2017</span></span></div>

<div style='margin: 15px 0; line-height: 1.5;'>Recently, I made a <a href="https://github.com/affinelayer/pix2pix-tensorflow">Tensorflow port</a> of <a href="https://github.com/phillipi/pix2pix">pix2pix by Isola et al.</a>, covered in the article <a href="https://affinelayer.com/pix2pix/">Image-to-Image Translation in Tensorflow</a>. I've taken a few pre-trained models and made an interactive web thing for trying them out.  Chrome is recommended.</div>

<div style='margin: 15px 0; line-height: 1.5;'>The pix2pix model works by training on pairs of images such as building facade labels to building facades, and then attempts to generate the corresponding output image from any input image you give it.  The idea is straight from the <a href="https://arxiv.org/abs/1611.07004">pix2pix paper</a>, which is a good read.</div>
<br/>
<div style="color: #888888; font-size: 30px;">edges2cats</div>
<div id="edges2cats"></div>

<div style='margin: 15px 0; line-height: 1.5;'>Trained on about 2k stock cat photos and edges automatically generated from those photos.  Generates cat-colored objects, some with nightmare faces.  The best one I've seen yet was a <a href="/pixsrv/beholder.jpg">cat-beholder</a>.</div>
<div style='margin: 15px 0; line-height: 1.5;'>Some of the pictures look especially creepy, I think because it's easier to notice when an animal looks wrong, especially around the eyes.  The auto-detected edges are not very good and in many cases didn't detect the cat's eyes, making it a bit worse for training the image translation model.</div>

<div style="color: #888888; font-size: 30px;">facades</div>
<div id="facades"></div>

<div style='margin: 15px 0; line-height: 1.5;'>Trained on a database of building facades to labeled building facades.  It doesn't seem sure about what to do with a large empty area, but if you put enough windows on there it often has reasonable results.  Draw "wall" color rectangles to erase things.</div>
<div style='margin: 15px 0; line-height: 1.5;'>I didn't have the names of the different parts of building facades so I just guessed what they were called.</div>

<div style="color: #888888; font-size: 30px;">edges2shoes</div>
<div id="edges2shoes"></div>

<div style='margin: 15px 0; line-height: 1.5;'>Trained on <a href="http://vision.cs.utexas.edu/projects/finegrained/utzap50k/">a database of ~50k shoe pictures</a> collected from Zappos</a> along with edges generated from those pictures automatically.  If you're really good at drawing the edges of shoes, you can try to produce some new designs.  Keep in mind it's trained on real objects, so if you can draw more 3D things, it seems to work better.</div>

<div style="color: #888888; font-size: 30px;">edges2handbags</div>
<div id="edges2handbags"></div>

<div style='margin: 15px 0; line-height: 1.5;'>Similar to the previous one, trained on a database of ~137k handbag pictures</a> collected from Amazon</a> and automatically generated edges from those pictures.  If you draw a shoe here instead of a handbag, you get a very oddly textured shoe.</div>

<div style='color:#888888;font-size:30px;margin-top:40px;'>Implementation</div>
<div style='margin: 15px 0; line-height: 1.5;'>The models were trained and exported with the <span style='color:#1f77b4;font-family:Monaco, Consolas, Menlo, &#34;Andale Mono WT&#34;, &#34;Andale Mono&#34;, &#34;Lucida Console&#34;, &#34;Lucida Sans Typewriter&#34;, &#34;DejaVu Sans Mono&#34;, &#34;Bitstream Vera Sans Mono&#34;, &#34;Liberation Mono&#34;, &#34;Nimbus Mono L&#34;, &#34;Courier New&#34;, Courier, monospace;font-size:17px;white-space:nowrap;'>pix2pix.py</span> script from <a href="https://github.com/affinelayer/pix2pix-tensorflow">pix2pix-tensorflow</a>.  The interactive demo is made in javascript using the Canvas API and runs the model using <a href="https://deeplearnjs.org/">deeplearn.js</a>.</div>

<div style='margin: 15px 0; line-height: 1.5;'>The pre-trained models are available in the <a href="https://github.com/affinelayer/pix2pix-tensorflow#datasets-and-trained-models">Datasets section</a> on GitHub.  All the ones released alongside the original pix2pix implementation should be available.  The models used for the javascript implementation are available at <a href="https://github.com/affinelayer/pix2pix-tensorflow-models">pix2pix-tensorflow-models</a>.</div>

<div style='margin: 15px 0; line-height: 1.5;'>The edges for the cat photos were generated using <a href="https://github.com/s9xie/hed">Holistically-Nested Edge Detection</a> and the functionality was added to <a href="https://github.com/affinelayer/pix2pix-tensorflow/blob/master/tools/process.py"><span style='font-family:Monaco, Consolas, Menlo, &#34;Andale Mono WT&#34;, &#34;Andale Mono&#34;, &#34;Lucida Console&#34;, &#34;Lucida Sans Typewriter&#34;, &#34;DejaVu Sans Mono&#34;, &#34;Bitstream Vera Sans Mono&#34;, &#34;Liberation Mono&#34;, &#34;Nimbus Mono L&#34;, &#34;Courier New&#34;, Courier, monospace;font-size:17px;'>process.py</span></a> and the dependencies were added to the <a href="https://hub.docker.com/r/affinelayer/pix2pix-tensorflow/">Docker image</a>.</div>

<script src="deeplearn-0.3.15.js"></script>
    <script>

    var editor_background = new Image()
    editor_background.src = "editor.png"

    var DEBUG = false
    var SIZE = 256

    var editors = []
    var request_in_progress = false

    function main() {
      var create_editor = function(config) {
        var editor = new Editor(config)
        var elem = document.getElementById(config.name)
        elem.appendChild(editor.view.ctx.canvas)
        editors.push(editor)
      }

      create_editor({
        name: "edges2cats",
        weights_url: "/models/edges2cats_AtoB.pict",
        mode: "line",
        clear: "#FFFFFF",
        colors: {
          line: "#000000",
          eraser: "#ffffff",
        },
        draw: "#000000",
        initial_input: "/edges2cats-input.png",
        initial_output: "/edges2cats-output.png",
        sheet_url: "/edges2cats-sheet.jpg",
      })

      create_editor({
        name: "edges2shoes",
        weights_url: "/models/edges2shoes_AtoB.pict",
        mode: "line",
        clear: "#FFFFFF",
        colors: {
          line: "#000000",
          eraser: "#ffffff",
        },
        draw: "#000000",
        initial_input: "/edges2shoes-input.png",
        initial_output: "/edges2shoes-output.png",
        sheet_url: "/edges2shoes-sheet.jpg",
      })

      create_editor({
        name: "edges2handbags",
        weights_url: "/models/edges2handbags_AtoB.pict",
        mode: "line",
        clear: "#FFFFFF",
        colors: {
          line: "#000000",
          eraser: "#ffffff",
        },
        draw: "#000000",
        initial_input: "/edges2handbags-input.png",
        initial_output: "/edges2handbags-output.png",
        sheet_url: "/edges2handbags-sheet.jpg",
      })

      create_editor({
        name: "facades",
        weights_url: "/models/facades_BtoA.pict",
        mode: "rect",
        colors: {
          background: "#0006d9",
          wall: "#0d3dfb",
          door: "#a50000",
          "window": "#0075ff",
          "window sill": "#68f898",
          "window head": "#1dffdd",
          shutter: "#eeed28",
          balcony: "#b8ff38",
          trim: "#ff9204",
          cornice: "#ff4401",
          column: "#f60001",
          entrance: "#00c9ff",
        },
        clear: "#0d3dfb",
        draw: "#0075ff",
        initial_input: "/facades-input.png",
        initial_output: "/facades-output.png",
        sheet_url: "/facades-sheet.jpg",
      })

      window.requestAnimationFrame(frame)
    }
    window.onload = main

    function render() {
      for (var i = 0; i < editors.length; i++) {
        editors[i].render()
      }
    }


    // model

    var weights_cache = {}
    function fetch_weights(path, progress_cb) {
      return new Promise(function(resolve, reject) {
        if (path in weights_cache) {
          resolve(weights_cache[path])
          return
        }

        var xhr = new XMLHttpRequest()
        xhr.open("GET", path, true)
        xhr.responseType = "arraybuffer"

        xhr.onprogress = function(e) {
          progress_cb(e.loaded, e.total)
        }

        xhr.onload = function(e) {
          if (xhr.status != 200) {
            reject("missing model")
            return
          }
          var buf = xhr.response
          if (!buf) {
            reject("invalid arraybuffer")
            return
          }

          var parts = []
          var offset = 0
          while (offset < buf.byteLength) {
            var b = new Uint8Array(buf.slice(offset, offset+4))
            offset += 4
            var len = (b[0] << 24) + (b[1] << 16) + (b[2] << 8) + b[3]
            parts.push(buf.slice(offset, offset + len))
            offset += len
          }

          var shapes = JSON.parse((new TextDecoder("utf8")).decode(parts[0]))
          var index = new Float32Array(parts[1])
          var encoded = new Uint8Array(parts[2])

          // decode using index
          var arr = new Float32Array(encoded.length)
          for (var i = 0; i < arr.length; i++) {
            arr[i] = index[encoded[i]]
          }

          var weights = {}
          var offset = 0
          for (var i = 0; i < shapes.length; i++) {
            var shape = shapes[i].shape
            var size = shape.reduce((total, num) => total * num)
            var values = arr.slice(offset, offset+size)
            var dlarr = dl.Array1D.new(values, "float32")
            weights[shapes[i].name] = dlarr.reshape(shape)
            offset += size
          }
          weights_cache[path] = weights
          resolve(weights)
        }
        xhr.send(null)
      })
    }

    function model(input, weights) {
      const math = dl.ENV.math

      function preprocess(input) {
        return math.subtract(math.multiply(input, dl.Scalar.new(2)), dl.Scalar.new(1))
      }

      function deprocess(input) {
        return math.divide(math.add(input, dl.Scalar.new(1)), dl.Scalar.new(2))
      }

      function batchnorm(input, scale, offset) {
        var moments = math.moments(input, [0, 1])
        const varianceEpsilon = 1e-5
        return math.batchNormalization3D(input, moments.mean, moments.variance, varianceEpsilon, scale, offset)
      }

      function conv2d(input, filter, bias) {
        return math.conv2d(input, filter, bias, [2, 2], "same")
      }

      function deconv2d(input, filter, bias) {
        var convolved = math.conv2dTranspose(input, filter, [input.shape[0]*2, input.shape[1]*2, filter.shape[2]], [2, 2], "same")
        var biased = math.add(convolved, bias)
        return biased
      }

      var preprocessed_input = preprocess(input)

      var layers = []

      var filter = weights["generator/encoder_1/conv2d/kernel"]
      var bias = weights["generator/encoder_1/conv2d/bias"]
      var convolved = conv2d(preprocessed_input, filter, bias)
      layers.push(convolved)

      for (var i = 2; i <= 8; i++) {
        var scope = "generator/encoder_" + i.toString()
        var filter = weights[scope + "/conv2d/kernel"]
        var bias = weights[scope + "/conv2d/bias"]
        var layer_input = layers[layers.length - 1]
        var rectified = math.leakyRelu(layer_input, 0.2)
        var convolved = conv2d(rectified, filter, bias)
        var scale = weights[scope + "/batch_normalization/gamma"]
        var offset = weights[scope + "/batch_normalization/beta"]
        var normalized = batchnorm(convolved, scale, offset)
        layers.push(normalized)
      }

      for (var i = 8; i >= 2; i--) {
        if (i == 8) {
          var layer_input = layers[layers.length - 1]
        } else {
          var skip_layer = i - 1
          var layer_input = math.concat3D(layers[layers.length - 1], layers[skip_layer], 2)
        }
        var rectified = math.relu(layer_input)
        var scope = "generator/decoder_" + i.toString()
        var filter = weights[scope + "/conv2d_transpose/kernel"]
        var bias = weights[scope + "/conv2d_transpose/bias"]
        var convolved = deconv2d(rectified, filter, bias)
        var scale = weights[scope + "/batch_normalization/gamma"]
        var offset = weights[scope + "/batch_normalization/beta"]
        var normalized = batchnorm(convolved, scale, offset)
        // missing dropout
        layers.push(normalized)
      }

      var layer_input = math.concat3D(layers[layers.length - 1], layers[0], 2)
      var rectified = math.relu(layer_input)
      var filter = weights["generator/decoder_1/conv2d_transpose/kernel"]
      var bias = weights["generator/decoder_1/conv2d_transpose/bias"]
      var convolved = deconv2d(rectified, filter, bias)
      var rectified = math.tanh(convolved)
      layers.push(rectified)

      var output = layers[layers.length - 1]
      var deprocessed_output = deprocess(output)

      return deprocessed_output
    }


    // editor

    function Editor(config) {
      this.config = config
      this.view = new View(this.config.name, 800, 400)

      this.buffers = []

      this.buffer = createContext(SIZE, SIZE, SCALE)
      this.buffer.fillStyle = this.config.clear
      this.buffer.fillRect(0, 0, SIZE, SIZE)

      var image = new Image()
      image.src = this.config.initial_input
      image.onload = () => {
        this.buffer.drawImage(image, 0, 0)
      }

      this.output = createContext(SIZE, SIZE, 1)
      var output = new Image()
      output.src = this.config.initial_output
      output.onload = () => {
        this.output.drawImage(output, 0, 0)
      }

      this.progress = null
      this.last_failure = null

      this.sheet_loaded = false
      this.sheet = new Image()
      this.sheet.src = this.config.sheet_url
      this.sheet.onload = () => {
        this.sheet_loaded = true
        update()
      }
      this.sheet_index = 0
    }

    Editor.prototype = {
      push_buffer: function() {
        this.buffers.push(this.buffer)
        var buffer = createContext(SIZE, SIZE, SCALE)
        buffer.save()
        buffer.scale(1/SCALE, 1/SCALE)
        buffer.drawImage(this.buffer.canvas, 0, 0)
        buffer.restore()
        this.buffer = buffer
      },
      pop_buffer: function() {
        if (this.buffers.length == 0) {
          return
        }
        this.buffer = this.buffers.pop()
      },
      render: function() {
        var v = this.view

        v.ctx.clearRect(0, 0, v.f.width, v.f.height)
        v.ctx.save()
        v.ctx.scale(1/SCALE, 1/SCALE)
        v.ctx.drawImage(editor_background, 0, 0)
        v.ctx.restore()

        v.frame("tools", 8, 41, 100, 250, () => {
          var i = 0
          for (var name in this.config.colors) {
            var color = this.config.colors[name]
            v.frame("color_selector", 0, i*21, v.f.width, 20, () => {
              if (v.contains(mouse_pos)) {
                cursor_style = "pointer"
              }

              if (mouse_released && v.contains(mouse_pos)) {
                this.config.draw = color
                update()
              }

              if (this.config.draw == color) {
                v.ctx.save()
                var radius = 5
                v.ctx.beginPath()
                v.ctx.moveTo(radius, 0)
                var sides = [v.f.width, v.f.height, v.f.width, v.f.height]
                for (var i = 0; i < sides.length; i++) {
                  var side = sides[i]
                  v.ctx.lineTo(side - radius, 0)
                  v.ctx.arcTo(side, 0, side, radius, radius)
                  v.ctx.translate(side, 0)
                  v.ctx.rotate(90 / 180 * Math.PI)
                }
                v.ctx.fillStyle = rgba([0.5, 0.5, 0.5, 1.0])
                v.ctx.stroke()
                v.ctx.restore()
                v.ctx.font = "bold 8pt Arial"
              } else {
                v.ctx.font = "8pt Arial"
              }

              v.ctx.fillText(name, v.f.width - v.ctx.measureText(name).width - 26, 10)

              v.frame("color", v.f.width-25, 0, 20, 20, () => {
                v.ctx.beginPath()
                v.ctx.fillStyle = "#666666"
                v.ctx.arc(10, 10, 9, 0, 2 * Math.PI, false)
                v.ctx.fill()
                v.ctx.beginPath()
                v.ctx.fillStyle = color
                v.ctx.arc(10, 10, 8, 0, 2 * Math.PI, false)
                v.ctx.fill()
              })
            })
            i++
          }
        })

        v.frame("output", 530, 40, 256, 256, () => {
          v.ctx.drawImage(this.output.canvas, 0, 0)
        })

        v.frame("input", 140, 40, 256, 256+40, () => {
          v.frame("image", 0, 0, 256, 256, () => {
            v.ctx.drawImage(this.buffer.canvas, 0, 0, v.f.width, v.f.height)

            if (v.contains(mouse_pos)) {
              cursor_style = "crosshair"
              if (this.config.mode == "line" && this.config.draw == "#ffffff") {
                // eraser tool
                cursor_style = "url(/eraser.png) 8 8, auto"
              }
            }

            if (this.config.mode == "line") {
              // this is to make undo work with lines, rather than removing only single frame line segments
              var drag_from_outside = mouse_down && v.contains(mouse_pos) && !v.contains(last_mouse_pos)
              var start_inside = mouse_pressed && v.contains(mouse_pos)
              if (drag_from_outside || start_inside) {
                this.push_buffer()
              }

              if (mouse_down && v.contains(mouse_pos)) {
                var last = v.relative(last_mouse_pos)
                var cur = v.relative(mouse_pos)
                this.buffer.beginPath()
                this.buffer.lineCap = "round"
                this.buffer.strokeStyle = this.config.draw
                if (this.config.draw == "#ffffff") {
                  // eraser mode
                  this.buffer.lineWidth = 15
                } else {
                  this.buffer.lineWidth = 1
                }
                this.buffer.moveTo(last.x, last.y)
                this.buffer.lineTo(cur.x, cur.y)
                this.buffer.stroke()
                this.buffer.closePath()
              }
            } else {
              if (v.contains(drag_start)) {
                var start = v.relative(drag_start)
                var end = v.relative(mouse_pos)
                var width = end.x - start.x
                var height = end.y - start.y
                if (mouse_down) {
                  v.ctx.save()
                  v.ctx.rect(0, 0, v.f.width, v.f.height)
                  v.ctx.clip()
                  v.ctx.fillStyle = this.config.draw
                  v.ctx.fillRect(start.x, start.y, width, height)
                  v.ctx.restore()
                } else if (mouse_released) {
                  this.push_buffer()
                  this.buffer.fillStyle = this.config.draw
                  this.buffer.fillRect(start.x, start.y, width, height)
                  v.ctx.drawImage(this.buffer.canvas, 0, 0, v.f.width, v.f.height)
                }
              }
            }
          })
        })

        v.frame("process_button", 461 - 32, 148, 32*2, 40, () => {
          if (this.progress != null) {
            v.ctx.font = "12px Arial"
            v.ctx.fillStyle = "#000"
            var s = "downloading"
            v.ctx.fillText(s, (v.f.width - v.ctx.measureText(s).width)/2, 5)
            s = "model"
            v.ctx.fillText(s, (v.f.width - v.ctx.measureText(s).width)/2, 15)

            v.frame("progress_bar", 0, 25, v.f.width, 15, () => {
              v.ctx.fillStyle = "#f92672"
              v.ctx.fillRect(0, 0, v.f.width * this.progress, v.f.height)
            })
          } else if (request_in_progress) {
            do_button(v, "running")
          } else {
            if (do_button(v, "process")) {
              if (request_in_progress) {
                console.log("request already in progress")
                return
              }
              request_in_progress = true
              this.last_failure = null

              this.progress = 0
              progress_cb = (retrieved, total) => {
                this.progress = retrieved/total
                update()
              }

              fetch_weights(this.config.weights_url, progress_cb).then((weights) => {
                this.progress = null
                update()
                // delay a short period of time so that UI updates before the model uses all the CPU
                delay(() => {
                  // var g = new dl.Graph()

                  var convert = createContext(SIZE, SIZE, 1)
                  convert.drawImage(this.buffer.canvas, 0, 0, convert.canvas.width, convert.canvas.height)
                  var input_uint8_data = convert.getImageData(0, 0, SIZE, SIZE).data
                  var input_float32_data = Float32Array.from(input_uint8_data, (x) => x / 255)

                  console.time('render')
                  const math = dl.ENV.math
                  math.startScope()
                  var input_rgba = dl.Array3D.new([SIZE, SIZE, 4], input_float32_data, "float32")
                  var input_rgb = math.slice3D(input_rgba, [0, 0, 0], [SIZE, SIZE, 3])

                  var output_rgb = model(input_rgb, weights)

                  var alpha = dl.Array3D.ones([SIZE, SIZE, 1])
                  var output_rgba = math.concat3D(output_rgb, alpha, 2)

                  output_rgba.getValuesAsync().then((output_float32_data) => {
                    var output_uint8_data = Uint8ClampedArray.from(output_float32_data, (x) => x * 255)
                    this.output.putImageData(new ImageData(output_uint8_data, SIZE, SIZE), 0, 0)
                    math.endScope()
                    console.timeEnd('render')
                    request_in_progress = false
                    update()
                  })
                })
              }, (e) => {
                this.last_failure = e
                this.progress = null
                request_in_progress = false
                update()
              })
            }
          }
        })

        v.frame("undo_button", 192-32, 310, 64, 40, () => {
          if (do_button(v, "undo")) {
            this.pop_buffer()
            update()
          }
        })

        v.frame("clear_button", 270-32, 310, 64, 40, () => {
          if (do_button(v, "clear")) {
            this.buffers = []
            this.buffer.fillStyle = this.config.clear
            this.buffer.fillRect(0, 0, SIZE, SIZE)
            this.output.fillStyle = "#FFFFFF"
            this.output.fillRect(0, 0, SIZE, SIZE)
          }
        })

        if (this.sheet_loaded) {
          v.frame("random_button", 347-32, 310, 64, 40, () => {
            if (do_button(v, "random")) {
              // pick next sheet entry
              this.buffers = []
              var y_offset = this.sheet_index * SIZE
              this.buffer.drawImage(this.sheet, 0, y_offset, SIZE, SIZE, 0, 0, SIZE, SIZE)
              this.output.drawImage(this.sheet, SIZE, y_offset, SIZE, SIZE, 0, 0, SIZE, SIZE)
              this.sheet_index = (this.sheet_index + 1) % (this.sheet.height / SIZE)
              update()
            }
          })
        }

        v.frame("save_button", 655-32, 310, 64, 40, () => {
          if (do_button(v, "save")) {
            // create a canvas to hold the part of the canvas that we wish to store
            var x = 125 * SCALE
            var y = 0
            var width = 800 * SCALE - x
            var height = 310 * SCALE - y
            var convert = createContext(width, height, 1)
            convert.drawImage(v.ctx.canvas, x, y, width, height, 0, 0, convert.canvas.width, convert.canvas.height)
            var data_b64 = convert.canvas.toDataURL("image/png").replace(/^data:image\/png;base64,/, "")
            var data = b64_to_bin(data_b64)
            var blob = new Blob([data], {type: "application/octet-stream"})
            var url = window.URL.createObjectURL(blob)
            var a = document.createElement("a")
            a.href = url
            a.download = "pix2pix.png"
            // use createEvent instead of .click() to work in firefox
            // also can"t revoke the object url because firefox breaks
            var event = document.createEvent("MouseEvents")
            event.initEvent("click", true, true)
            a.dispatchEvent(event)
            // safari doesn"t work at all
          }
        })

        if (this.last_failure != null) {
          v.frame("server_error", 50, 350, v.f.width, 50, () => {
            v.ctx.font = "20px Arial"
            v.ctx.fillStyle = "red"
            v.center_text(fmt("error %s", this.last_failure))
          })
        }
      },
    }

    // utility

    function createContext(width, height, scale) {
      var canvas = document.createElement("canvas")
      canvas.width = width * scale
      canvas.height = height * scale
      stylize(canvas, {
        width: fmt("%dpx", width),
        height: fmt("%dpx", height),
        margin: "10px auto 10px auto",
      })
      var ctx = canvas.getContext("2d")
      ctx.scale(scale, scale)
      return ctx
    }

    function b64_to_bin(str) {
      var binstr = atob(str)
      var bin = new Uint8Array(binstr.length)
      for (var i = 0; i < binstr.length; i++) {
        bin[i] = binstr.charCodeAt(i)
      }
      return bin
    }

    function delay(fn) {
      setTimeout(fn, 0)
    }

    function default_format(obj) {
      if (typeof(obj) === "string") {
        return obj
      } else {
        return JSON.stringify(obj)
      }
    }

    function fmt() {
      if (arguments.length === 0) {
        return "error"
      }

      var format = arguments[0]
      var output = ""

      var arg_index = 1
      var i = 0

      while (i < format.length) {
        var c = format[i]
        i++

        if (c != "%") {
          output += c
          continue
        }

        if (i === format.length) {
          output += "%!(NOVERB)"
          break
        }

        var flag = format[i]
        i++

        var pad_char = " "

        if (flag == "0") {
          pad_char = "0"
        } else {
          // not a flag
          i--
        }

        var width = 0
        while (format[i] >= "0" && format[i] <= "9") {
          width *= 10
          width += parseInt(format[i], 10)
          i++
        }

        var f = format[i]
        i++

        if (f === "%") {
          output += "%"
          continue
        }

        if (arg_index === arguments.length) {
          output += "%!" + f + "(MISSING)"
          continue
        }

        var arg = arguments[arg_index]
        arg_index++

        var o = null

        if (f === "v") {
          o = default_format(arg)
        } else if (f === "s" && typeof(arg) === "string") {
          o = arg
        } else if (f === "T") {
          o = typeof(arg)
        } else if (f === "d" && typeof(arg) === "number") {
          o = arg.toFixed(0)
        } else if (f === "f" && typeof(arg) === "number") {
          o = arg.toString()
        } else if (f === "x" && typeof(arg) === "number") {
          o = Math.round(arg).toString(16)
        } else if (f === "t" && typeof(arg) === "boolean") {
          if (arg) {
            o = "true"
          } else {
            o = "false"
          }
        } else {
          output += "%!" + f + "(" + typeof(arg) + "=" + default_format(arg) + ")"
        }

        if (o !== null) {
          if (o.length < width) {
            output += Array(width - o.length + 1).join(pad_char)
          }
          output += o
        }
      }

      if (arg_index < arguments.length) {
        output += "%!(EXTRA "
        while (arg_index < arguments.length) {
          var arg = arguments[arg_index]
          output += typeof(arg) + "=" + default_format(arg)
          if (arg_index < arguments.length - 1) {
            output += ", "
          }
          arg_index++
        }
        output += ")"
      }

      return output
    }


    // immediate mode UI

    var SCALE = 2

    var updated = true
    var frame_rate = 0
    var now = new Date()
    var last_frame = new Date()
    var animations = {}
    var values = {}

    var cursor_style = null
    var mouse_pos = [0, 0]
    var last_mouse_pos = [0, 0]
    var drag_start = [0, 0]
    var mouse_down = false
    var mouse_pressed = false
    var mouse_released = false

    if (DEBUG) {
      var fps_elem = document.createElement("div")
      stylize(fps_elem, {
        width: "300px",
        height: "20px",
        margin: "5px",
        fontFamily: "Monaco",
        fontSize: "12px",
        position: "absolute",
        top: fmt("%dpx", 10),
        right: fmt("%dpx", 10),
      })
      document.body.insertBefore(fps_elem, document.body.firstChild)

      var status_elem = document.createElement("div")
      stylize(status_elem, {
        width: "10px",
        height: "10px",
        margin: "5px",
        position: "absolute",
        top: fmt("%dpx", 10),
        left: fmt("%dpx", 10),
      })
      document.body.insertBefore(status_elem, document.body.firstChild)
    }

    function View(name, width, height) {
      this.ctx = createContext(width, height, SCALE)
      // https://developer.apple.com/library/safari/documentation/AudioVideo/Conceptual/HTML-canvas-guide/AddingText/AddingText.html
      this.ctx.textBaseline = "middle"
      this.frames = [{name: name, offset_x: 0, offset_y: 0, width: width, height: height}]
      this.f = this.frames[0]
    }

    View.prototype = {
      push_frame: function(name, x, y, width, height) {
        this.ctx.save()
        this.ctx.translate(x, y)
        var current = this.frames[this.frames.length - 1]
        var next = {name: name, offset_x: current.offset_x + x, offset_y: current.offset_y + y, width: width, height: height}
        this.frames.push(next)
        this.f = next
      },
      pop_frame: function() {
        this.ctx.restore()
        this.frames.pop()
        this.f = this.frames[this.frames.length - 1]
      },
      frame: function(name, x, y, width, height, func) {
        this.push_frame(name, x, y, width, height)
        func()
        this.pop_frame()
      },
      frame_path: function() {
        var parts = []
        for (var i = 0; i < this.frames.length; i++) {
          parts.push(this.frames[i].name)
        }
        return parts.join(".")
      },
      relative: function(pos) {
        // adjust x and y relative to the top left corner of the canvas
        // then adjust relative to the current frame
        var rect = this.ctx.canvas.getBoundingClientRect()
        return {x: pos.x - rect.left - this.f.offset_x, y: pos.y - rect.top - this.f.offset_y}
      },
      contains: function(pos) {
        // first check that position is inside canvas container
        var rect = this.ctx.canvas.getBoundingClientRect()
        if (pos.x < rect.left || pos.x > rect.left + rect.width || pos.y < rect.top || pos.y > rect.top + rect.height) {
          return false
        }
        // translate coordinates to the current frame
        var rel = this.relative(pos)
        return 0 < rel.x && rel.x < this.f.width && 0 < rel.y && rel.y < this.f.height
      },
      put_image_data: function(d, x, y) {
        this.ctx.putImageData(d, (x + this.f.offset_x) * SCALE, (y + this.f.offset_y) * SCALE)
      },
      center_text: function(s) {
        this.ctx.fillText(s, (this.f.width - this.ctx.measureText(s).width)/2, this.f.height/2)
      },
    }

    function do_button(v, text) {
      name = v.frame_path()

      if (v.contains(mouse_pos)) {
        cursor_style = "pointer"
      }

      if (request_in_progress) {
        animate(name, parse_color("#aaaaaaFF"), 100)
      } else if (mouse_down && v.contains(mouse_pos)) {
        animate(name, parse_color("#FF0000FF"), 50)
      } else {
        if (v.contains(mouse_pos)) {
          animate(name, parse_color("#f477a5FF"), 100)
        } else {
          animate(name, parse_color("#f92672FF"), 100)
        }
      }

      v.ctx.save()
      var radius = 5
      v.ctx.beginPath()
      v.ctx.moveTo(radius, 0)
      var sides = [v.f.width, v.f.height, v.f.width, v.f.height]
      for (var i = 0; i < sides.length; i++) {
        var side = sides[i]
        v.ctx.lineTo(side - radius, 0)
        v.ctx.arcTo(side, 0, side, radius, radius)
        v.ctx.translate(side, 0)
        v.ctx.rotate(90 / 180 * Math.PI)
      }
      v.ctx.fillStyle = rgba(calculate(name))
      v.ctx.fill()
      v.ctx.restore()

      v.ctx.font = "16px Arial"
      v.ctx.fillStyle = "#f8f8f8"
      v.center_text(text)

      if (request_in_progress) {
        return false
      }

      return mouse_released && v.contains(mouse_pos) && v.contains(drag_start)
    }

    function stylize(elem, style) {
      for (var key in style) {
        elem.style[key] = style[key]
      }
    }

    function update() {
      updated = true
    }

    function frame() {
      var raf = window.requestAnimationFrame(frame)

      if (!updated && Object.keys(animations).length == 0) {
        if (DEBUG) {
          status_elem.style.backgroundColor = "black"
        }
        return
      }
      if (DEBUG) {
        status_elem.style.backgroundColor = "red"
      }

      now = new Date()
      cursor_style = null
      updated = false

      try {
        render()
      } catch (e) {
        window.cancelAnimationFrame(raf)
        throw e
      }

      if (cursor_style == null) {
        document.body.style.cursor = "default"
      } else {
        document.body.style.cursor = cursor_style
      }

      if (DEBUG) {
        var decay = 0.9
        var current_frame_rate = 1 / ((now - last_frame) / 1000)
        frame_rate = frame_rate * decay + current_frame_rate * (1 - decay)
        fps_elem.textContent = fmt("fps: %d", frame_rate)
      }

      last_frame = now
      last_mouse_pos = mouse_pos
      mouse_pressed = false
      mouse_released = false
    }

    function array_equal(a, b) {
      if (a.length != b.length) {
        return false
      }

      for (var i = 0; i < a.length; i++) {
        if (a[i] != b[i]) {
          return false
        }
      }
      return true
    }

    function animate(name, end, duration) {
      if (values[name] == undefined) {
        // no value has been set for this element, set it immediately
        values[name] = end
        return
      }

      var v = calculate(name)
      if (array_equal(v, end)) {
        return
      }
      if (duration == 0) {
        delete animations[name]
        values[name] = end
        return
      }
      var a = animations[name]
      if (a != undefined && array_equal(a.end, end)) {
        return
      }
      animations[name] = {time: now, start: v, end: end, duration: duration}
    }

    function calculate(name) {
      if (values[name] == undefined) {
        throw "calculate used before calling animate"
      }

      var a = animations[name]
      if (a != undefined) {
        // update value
        var t = Math.min((now - a.time)/a.duration, 1.0)
        t = t*t*t*(t*(t*6 - 15) + 10) // smootherstep
        var result = []
        for (var i = 0; i < a.start.length; i++) {
          result[i] = a.start[i] + (a.end[i] - a.start[i]) * t
        }
        if (t == 1.0) {
          delete animations[name]
        }
        values[name] = result
      }
      return values[name]
    }

    function rgba(v) {
      return fmt("rgba(%d, %d, %d, %f)", v[0] * 255, v[1] * 255, v[2] * 255, v[3])
    }

    var parse_color = function(c) {
      return [
        parseInt(c.substr(1,2), 16) / 255,
        parseInt(c.substr(3,2), 16) / 255,
        parseInt(c.substr(5,2), 16) / 255,
        parseInt(c.substr(7,2), 16) / 255,
      ]
    }

    document.addEventListener("mousemove", function(e) {
      mouse_pos = {x: e.clientX, y: e.clientY}
      update()
    })

    document.addEventListener("mousedown", function(e) {
      drag_start = {x: e.clientX, y: e.clientY}
      mouse_down = true
      mouse_pressed = true
      update()
    })

    document.addEventListener("mouseup", function(e) {
      mouse_down = false
      mouse_released = true
      update()
    })

    </script>
    </div><div style='background-color:rgba(0, 0, 0, 0.2);height:1px;margin:10px auto 10px auto;width:400px;'></div><div style='margin:30px auto 30px auto;text-align:center;'>all code samples on this site are in the public domain unless otherwise stated</div><div style='height:50px;margin:10px auto 50px auto;position:relative;width:550px;'><a href='https://twitter.com/christophrhesse' style='left:35px;position:absolute;top:0;'><img style="width: 50px; height: 50px;" src="data:image/svg+xml,%3C%3Fxml version%3D%221.0%22 encoding%3D%22UTF-8%22 standalone%3D%22no%22%3F%3E%0A%3Csvg width%3D%22100px%22 height%3D%22100px%22 viewBox%3D%220 0 100 100%22 version%3D%221.1%22 xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A    %3C%21-- Generator%3A Sketch 42 %2836781%29 - http%3A%2F%2Fwww.bohemiancoding.com%2Fsketch --%3E%0A    %3Ctitle%3Etwitter%3C%2Ftitle%3E%0A    %3Cdesc%3ECreated with Sketch.%3C%2Fdesc%3E%0A    %3Cdefs%3E%3C%2Fdefs%3E%0A    %3Cg id%3D%22Page-1%22 stroke%3D%22none%22 stroke-width%3D%221%22 fill%3D%22none%22 fill-rule%3D%22evenodd%22%3E%0A        %3Cg id%3D%22twitter%22 fill-rule%3D%22nonzero%22 fill%3D%22%23F92672%22%3E%0A            %3Cpath d%3D%22M35.7519134%2C81.2096791 C64.7360437%2C81.2096791 80.5863373%2C57.1976441 80.5863373%2C36.3752552 C80.5863373%2C35.6932286 80.5724457%2C35.0142948 80.5418534%2C34.338428 C83.6186144%2C32.1141808 86.2928038%2C29.338498 88.4020526%2C26.1787484 C85.5786385%2C27.4337309 82.540279%2C28.2785644 79.3529525%2C28.6595127 C82.6062574%2C26.7086895 85.1039029%2C23.6227275 86.2822369%2C19.943913 C83.2376919%2C21.7488105 79.8660896%2C23.060622 76.2761914%2C23.7688595 C73.4007162%2C20.7060158 69.3069591%2C18.7903209 64.7740329%2C18.7903209 C56.0720928%2C18.7903209 49.0154906%2C25.8471809 49.0154906%2C34.5457705 C49.0154906%2C35.7822996 49.1537361%2C36.9850662 49.4240931%2C38.1387614 C36.327627%2C37.4797758 24.7146452%2C31.209477 16.9425891%2C21.6750744 C15.5893091%2C24.0037531 14.8089849%2C26.7087668 14.8089849%2C29.5950666 C14.8089849%2C35.0620004 17.5909047%2C39.8882215 21.8212579%2C42.7116355 C19.2359848%2C42.6317604 16.8074106%2C41.9220847 14.6847599%2C40.7408384 C14.6824403%2C40.8069509 14.6824403%2C40.8714061 14.6824403%2C40.942065 C14.6824403%2C48.5734014 20.1140653%2C54.9449617 27.3242736%2C56.3887559 C26.0001685%2C56.7497302 24.6070436%2C56.9432842 23.1691772%2C56.9432842 C22.1553769%2C56.9432842 21.1676588%2C56.8435021 20.2076207%2C56.659113 C22.2137266%2C62.9201078 28.0309648%2C67.4762296 34.9277754%2C67.6035474 C29.534552%2C71.8308078 22.7405749%2C74.348556 15.3566577%2C74.348556 C14.0863146%2C74.348556 12.831358%2C74.2762993 11.5979474%2C74.1304302 C18.5718189%2C78.6004707 26.8526308%2C81.2086816 35.7527639%2C81.2086816%22 id%3D%22Shape%22%3E%3C%2Fpath%3E%0A        %3C%2Fg%3E%0A    %3C%2Fg%3E%0A%3C%2Fsvg%3E"></a><a href='/feed.xml' style='left:85px;position:absolute;top:0;'><img style="width: 50px; height: 50px;" src="data:image/svg+xml,%3C%3Fxml version%3D%221.0%22 encoding%3D%22UTF-8%22 standalone%3D%22no%22%3F%3E%0A%3Csvg width%3D%22100px%22 height%3D%22100px%22 viewBox%3D%220 0 100 100%22 version%3D%221.1%22 xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A    %3C%21-- Generator%3A Sketch 42 %2836781%29 - http%3A%2F%2Fwww.bohemiancoding.com%2Fsketch --%3E%0A    %3Ctitle%3Erss%3C%2Ftitle%3E%0A    %3Cdesc%3ECreated with Sketch.%3C%2Fdesc%3E%0A    %3Cdefs%3E%3C%2Fdefs%3E%0A    %3Cg id%3D%22Page-1%22 stroke%3D%22none%22 stroke-width%3D%221%22 fill%3D%22none%22 fill-rule%3D%22evenodd%22%3E%0A        %3Cg id%3D%22rss%22 fill%3D%22%23F92672%22%3E%0A            %3Cellipse id%3D%22Oval-1%22 cx%3D%2228.4712624%22 cy%3D%2270.0384616%22 rx%3D%228.47900866%22 ry%3D%228.2913302%22%3E%3C%2Fellipse%3E%0A            %3Cpath d%3D%22M19%2C36.7735036 C41.6946018%2C38.6161117 59.8351412%2C56.1456608 62.0519035%2C78.2440986 L49.7815343%2C78.2440986 C47.6709502%2C62.736186 34.9565604%2C50.5052613 19%2C48.7500136 L19%2C36.7735036 Z%22 id%3D%22Oval-1%22%3E%3C%2Fpath%3E%0A            %3Cpath d%3D%22M19%2C16.1912989 C53.2966503%2C18.1111482 80.8090992%2C44.7986803 83.1198892%2C78.2440986 L70.0797727%2C78.2440986 C67.8187966%2C51.8248273 46.1124387%2C30.811446 19%2C28.9325028 L19%2C16.1912989 Z%22 id%3D%22Oval-1%22%3E%3C%2Fpath%3E%0A        %3C%2Fg%3E%0A    %3C%2Fg%3E%0A%3C%2Fsvg%3E"></a><form action='https://app.affinelayer.com/subscribe' method='post' onsubmit='window.open(&#39;https://app.affinelayer.com/subscribe&#39;, &#39;popupwindow&#39;, &#39;scrollbars=yes,width=800,height=600&#39;);return true' style='left:150px;position:absolute;top:5px;' target='popupwindow'><label for='address' style='display:none;'>Enter your email address</label><input id='address' name='address' placeholder='Your email address' style='font-size:20px;padding:6px;width:250px;' type='text'></input><input style='background:#fff0f5;border:0 none;border-radius:5px;cursor:pointer;font-size:20px;margin-left:8px;padding:8px 15px;' type='submit' value='Subscribe'></input></form>
  </div>
</body>
</html>
